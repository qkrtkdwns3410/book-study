# 5장 :: 안정해시

## Discord의 채팅 메세지 분산

* 디스코드에는 수백만 개의 채팅방(채널)이 존재하며 수천 대의 서버(작업자 노드)가 존재함.

* 만약 채팅방에 1000명이 접속해있고 1000명이 모두 다른 서버에 할당되어 있다면, 서버들끼리 서로 데이터를 주고받느라 엄청난 부하가 걸릴 것.

* 그렇기에 특정 채팅방에서 일어나는 일은 무조건 한 서버가 전담해야 함.

* 채팅방들에 대해 적절히 서버를 배치하기 위해 Ringpop이라는 안정 해시 라이브러리를 사용.

* 수많은 채팅방을 수천 대의 서버에 효율적으로 나눠주기 위해 사용됨.

### 1000명의 채팅방과 50명의 채팅방, 유령 채팅방도 구분해줘야하지 않나?

* 데이터 핫스팟 문제 해결이 필요

* 부하 제한 안정 해시 (Bounded Load Consistent Hashing) 사용
  * 서버가 꽉차면 옆으로 넘기자는 방식
  * 안정 해시에 의해 특정 채팅방이 서버254에 당첨되었는데 서버254는 설정된 한계치의 부하를 받고 있다면 넘겨버림.
* Fan-out (초대형 방 쪼개기)
  * 실제로 1000명의 채팅방(ex. 배틀그라운드 공식 디스코드)는 단일 서버(Node)하나가 절대 감당할 수 없음.
  * 1000명의 채팅방A가 서버677에 당첨되었다면 677는 관리자 역할만 하고 실제 유저 트래픽은 서버245, 서버798, 서버231에 분배
* 유령방은 딱히 문제가 안됨. 어차피 트래픽 안먹으니, 있으나 마나

### 여러 노드가 부하를 받는다면 되돌아가서 모순 아닌가?

* 하나의 방을 여러 노드가 나눠 처리한다면, 필연적으로 노드끼리 통신해야함.

* "어쩔 수 없음"

* 그래도 마구잡이로 노드에 분배하는 것 보단 전체 시스템적으로 이득
  * 1000명인 디스코드 채널이 전체의 몇프로나 될까? -> 1%미만
  * 1%만 서버끼리 통신하는 구조, 99%는 하나의 노드로만 해결하는 구조
  * "완벽한 격리는 없다. 최대한 효율적으로"

# SHA-256 보다 더 나은 선택

* 안정 해시에서 SHA-256 같은 암호화 해시는 너무 느리고 CPU를 많이 씀.
* 그렇다고 자바의 기본 hashCode()는 분포가 안좋음.

* 해결책
  * MurmurHash, CityHash와 같은 비암호화 해시 함수 사용하는 것이 좋음

* 안정해시는 스마트한 분배를 위한 것이지 보안적인 이슈가 중요한 것이 아니기 때문.

# Sticky Session

* 기존 방식
  * 사용자의 IP를 해싱하여 특정 서버에 고정(매핑)
  * 서버A가 죽으면 A에 붙어있던 모든 세션 사라지고, A에 의해 모듈러 값이 바뀌어 모든 세션이 재분배(로그아웃) 됨.
* 안정해시 적용 방식
  * 쿠키나 헤더값을 키로 하여 안정 해시 링을 조회
  * 서버가 스케일 아웃되어도 k/n만 재배치(로그아웃) 됨. (기존은 k개 재배치 - all!)
  * **근데 결국 서버 수 변동에 대해 재배치가 없는건 아님.**