# 1장

## 지리적 라우팅에 대한 추가 궁금점

### 클라우드 DNS 서비스의 지리적 라우팅(Route53)

사용자가 브라우저에 `genesisnest.com`을 치면,

브라우저는 Route53에게 `genesisnest.com`실제 ip를 받게 된다.

책에서 배운 지리적 라우팅은 가장 가까운 서버로의 흐름을 만들어 속도적 이점을 강조했다.

하지만 내 의문은, 가장 처음의 흐름인 Route53에 대한 질의는 어떻게 이루어지지라는 것이었다.

우리는 Route53 설정시 내 EC2의 리전을 명시하지 않기 때문이다.

Route53 자체가 멀면, dns질의 자체가 늦어지는 것은 어떻게 극복할까 라는 의문이었고

AWS는 실제로 전 세계에 Edge Location을 구축하여 브라우저에 의해 요청자의 ip는 네트워크를 타고 가장 가까운 AWS Route53을 통해 질의하고 

요청이 가야할 로드밸런서로 브라우저가 진정한 요청을 보내게 된다.

#### 애니캐스트(Anycast)

전 세계에 수 많이 Route53 서버가 존재하는 것은 파악했다.

그런데 우리의 요청에 대한 요청자 IP만 가지고 어떻게 Route53에 도달하는걸까?

이는 애니캐스트로 가능하다.

보통의 `IP(Unicast)`는 전 세계에서 단 한 대의 장비만 그 주소를 가지나, `Anycast IP`는 전 세계 수백개의 AWS 데이터 센터가 같은 IP를 가진다.

사용자가 `1.1.1.1`(AWS Anycast IP)로 패킷을 보내면 인터넷 망의 라우터들은 물리적으로 가장 짧은 경로에 있는 `1.1.1.1`로 패킷을 던진다.

**그렇기에 우리가 DNS 질의에 대한 속도 걱정(최적화 고민)은 하지 않아도 된다.**

## L4 / L7 로드밸런서

### ALB(L7) vs NLB(L4) 비교

| 구분 | Application Load Balancer (ALB) | Network Load Balancer (NLB) |
| --- | --- | --- |
| **주요 타겟** | HTTP / HTTPS / gRPC | TCP / UDP / TLS |
| **판단 근거** | URL 경로, 헤더, 쿠키 (내용 분석) | IP, Port (단순 전달) |
| **IP 주소** | 유동 IP (DNS 기반 접속) | **고정 IP (Elastic IP 지원)** |
| **처리 속도** | 분석 프로세스로 인해 NLB보다 느림 | 하드웨어 수준의 비정상적으로 빠른 속도 |
| **용도** | 일반 웹 및 API 서비스 | 대용량 트래픽, 고정 IP 필수 환경 |

백엔드 개발자로서 인프라의 동작 원리를 파악할 수 있도록, L4(NLB)와 L7(ALB)의 IP 할당 방식 차이를 요약하여 정리해 드립니다.

### NLB(L4)가 고정 IP인 이유
"단순 전달 방식이기에 확장이 필요 없는 강력한 입구임"

동작 원리: 패킷의 내용을 열지 않고 IP와 포트만 확인하여 즉시 전달함. 이는 소프트웨어가 아닌 전용 하드웨어(ASIC) 수준에서 처리됨.

성능의 한계: 장비 한 대가 처리할 수 있는 대역폭이 비정상적으로 큼. 따라서 트래픽이 늘어나도 새로운 장비(IP)를 추가할 필요 없이 기존 IP로 모두 수용이 가능함.

사례 (은행 연동): 보안이 철저한 금융권은 화이트리스트 기반 방화벽을 운영함. 이때 서버 IP가 바뀌면 접속이 차단되므로, 변하지 않는 **고정 IP(Static IP)**를 제공하는 NLB가 필수적임.

### ALB(L7)가 유동 IP인 이유
"내용 분석을 위해 컴퓨팅 자원이 투입되며, 성능에 따라 입구가 늘어남"

동작 원리: 패킷을 완전히 수신하여 URL, 헤더, 쿠키 등 내부 콘텐츠를 소프트웨어(CPU)가 읽고 판단함.

확장 방식: 트래픽이 폭주하면 내용을 분석하는 '분석 노드(비서)'를 실시간으로 늘려야 함. 이때 AWS가 새로운 분석 노드를 추가할 때마다 각 노드에 고유한 IP가 부여됨, 노드는 로드밸런서의 입구임. 입구를 늘린다는건 Route53에 입구 주소(새로 추가된 노드의 IP)를 등록해주어야 함. Route53은 새로 생긴 노드의 IP까지 해서 접속할 ALB의 ip리스트를 브라우저에게 줌.(브라우저는 랜덤으로 이 ip리스트중 ip를 선택)

주소 관리: 노드가 늘어나거나 줄어들 때마다 IP가 계속 변함. 따라서 사용자는 IP가 아닌 **DNS 이름(도메인)**을 통해 접속해야 하며, AWS가 도메인에 연결된 IP 리스트를 자동으로 관리함.

사례 (쇼핑몰): /order 요청과 /images 요청을 서로 다른 서버로 보내려면 패킷을 뜯어봐야 함. 이 지능적인 처리를 위해 노드가 가변적으로 변하므로(추가되므로) 유동 IP 구조를 가짐.(패킷을 뜯어서 분석하는 것도 ALB의 부담이니 노드가 추가될 수 있음.)

**ALB는 실제로 특수 목적의 EC2 인스턴스들이다..**

## 인프런(Inflearn)의 정적 콘텐츠 개선 사례

참고: https://jojoldu.tistory.com/779

인프런 서비스의 상단 헤더에 노출되는 강의 카테고리에 관한 이야기이다.

이 강의 카테고리 데이터는 모든 페이지에서 호출되고 있어, 페이지 조회수 만큼의 캐시 API를 호출하게 된다.

즉 서버로 요청이 들어가고 DB에서 데이터를 내려주는 것이 아니라 캐시에서 데이터를 내려준다고 하더라도 결국 서버는 트래픽을 받는다는 것이
문제점이었다.

EC2 스펙을 줄이기 위해 이 캐시 API 요청을 줄이고자, 인프런은 이 카테고리 데이터에 대해 서버에 요청하지 않는 분리된 방법을 선택한다.

이 카테고리 JSON 응답을 CDN에 캐싱해놓고 프론트엔드가 서버를 타지 않고 바로 CDN에서 데이터를 받는 구조이다.

CDN 캐시가 꼭 HTML, JS파일에만 적용되어야 한다고 하는 생각에서 벗어난 것이다.

정적 자원 서버(ex.S3)의 경우에는 보통 이미지나 JS파일, 등을 담아놓고 사용하고 CDN은 이를 캐싱한다. 

정확히는 이에 대한 HTTP 응답 전체를 캐싱한다.

API 서버가 응답하는 HTTP 응답과 S3가 응답하는 HTTP 응답은 이 응답들의 요청안에 개인화된 헤더가 존재하는 지 여부가 둘의 경우가 다르다.

API 서버는 충분히 그럴 수 있다.(세션)

즉 API응답을 CDN에 캐싱할 때, 특정A사용자의 세션 쿠키 정보가 CDN에 캐싱될 수 있다.

**인프런은 이 개선을 통해 카테고리 영역의 요청은 애플리케이션 서버 계층에서 벗어날 수 있게 되었으며, 해당 public API의 요청수와 로드를 절반 이하로 줄였다고 발표했다.**

