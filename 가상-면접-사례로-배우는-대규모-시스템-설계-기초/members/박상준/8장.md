8장 URL 단축기 설계

## URL 단축키 설계에서 레플리카 복제 지연이 발생한다면?

- 참고할만한 내용 → 컨플 기술 공유회에 남겨놓음 : [실시간 동기화는 존재하지 않는다 - MySQL 레플리케이션 동작 방식에 대해 - 현대지원개발팀 - GenesisNest](https://genesisnest.atlassian.net/wiki/spaces/kVTmUuNXbirx/pages/1962967044/-+MySQL)

```json
URL 단축 요청 (Primary에 저장)
    ↓
[가져오기 - IO Thread]
Primary binlog → 네트워크 전송 → Replica Relay Log 저장
    ↓
[적용 - SQL Thread]  
Relay Log 읽기 → Replica에서 실행
    ↓
Replica 동기화 완료
```

- 레플리카  지연 = 마스터 DB 실행 시간 - 레플리카 반영 시간

URL 단축키 상의 문제

```json
시간축:
T0: 사용자가 긴 URL 제출
T1: Primary에 저장 완료 (ID=12345, short=abc123)
T2: 단축 URL 반환: https://tinyurl.com/abc123
T3: 사용자가 바로 클릭!
T4: Load Balancer → Replica로 요청
T5: Replica 조회... 없음! (아직 복제 안됨)
T6: 404 Error 💥

[--- 지연 구간 ---]
T7: Replica에 복제 완료
```

- Primary 서버 - binlog 확인

    ```json
    SHOW BINARY LOGS;
    
    +-------------+---------+---------+
    |Log_name     |File_size|Encrypted|
    +-------------+---------+---------+
    |binlog.000001|2995723  |No       |
    |binlog.000002|157      |No       |
    +-------------+---------+---------+
    ```

- URL 단축 시

    ```json
    -- Primary에서 실행
    INSERT INTO url (longURL) VALUES ('https://example.com/...');
    ```

  - → 이게 `binlog.000002`에 기록됨!
- Replica 서버 - Relay Log 확인

    ```json
    bash-5.1# ls -lh /var/lib/mysql/relay-log.*
    -rw-r----- 1 mysql mysql 204 Feb  7 15:03 relay-log.000001
    -rw-r----- 1 mysql mysql 621 Feb  7 15:04 relay-log.000002
    -rw-r----- 1 mysql mysql  38 Feb  7 15:03 relay-log.index
    ```


**동작:**

1. Primary의 `binlog.000002`
2. → IO Thread가 네트워크로 가져옴
3. → Replica의 `relay-log.000002`에 저장
4. → SQL Thread가 읽어서 실행

---

- 전통적인 방식으로는
  - 같은 DB 내용에 대해 순차적으로 레플리카에 적용됨
  - 정말 트랜잭션이 많은 경우에는 지연이 어느정도 있음..
- 레플리카 복제 방식을 GTID 로 변경하여
  - 레플리카 복제를 병렬적으로 하게 해야함
