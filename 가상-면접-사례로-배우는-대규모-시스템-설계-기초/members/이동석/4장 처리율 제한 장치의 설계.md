- aws 클라우드 진영에서 api gateway의 ratelimiter 적용은?

  - api gateway usage plan 적용
  - aws waf (web application firewall 웹 어플리케이션 방화벽)에서 rate limit 관련 규칙 적용
  - 참고
    - https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-request-throttling.html
    - https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-api-usage-plans.html
    - https://docs.aws.amazon.com/waf/latest/developerguide/waf-rule-statement-type-rate-based-request-limiting.html
  - 사용량 플랜의 스로틀링 및 할당량은 엄격한 제한이 아니며, 최선을 다해 적용하는 방식입니다. 경우에 따라 클라이언트가 설정한 할당량을 초과할 수 있습니다. 비용을 제어하거나 API 접근을 차단하기 위해 사용량 플랜 할당량이나 스로틀링에 의존하지 마십시오. 비용 모니터링에는 [AWS Budgets를 , API 요청 관리에는 ](https://docs.aws.amazon.com/cost-management/latest/userguide/budgets-managing-costs.html)[AWS WAF를](https://docs.aws.amazon.com/waf/latest/developerguide/waf-chapter.html) 사용하는 것을 고려해 보세요  .

- 전직장에서는 api gateway로 kong을 썼음. rate limiter라는 플러그인 을 썻다면 제한이 가능했다고 함.

  - 'Kong'는 API 게이트웨이 그 자체이고, 'Konga'는 Kong API 게이트웨이를 시각적으로 관리해주는 **웹 기반의 관리 도구(GUI 대시보드)**
    - https://developer.konghq.com/plugins/rate-limiting/
    - https://m.blog.naver.com/zlatmgpdjtiq/223059860247

- 이동 윈도 로깅 알고리즘

  - 새 요청이 오면 만료된 타임 스탬프는 제거한다. 만료된 타임 스탬프는 그 값이 현재 윈도우읭 시작 시점보다 오래된 타임스탬프를 의미한다.
  - ex) 1:01:40에 요청이 왔다 그리고 분다 2회 요청을 처리하는 시스템이다. 그러면 1:00:40~1:01:40을 타임 윈도우로 계산, 1:00:40오래된 요청 만료 처리, 그리고서 요청의 한도를 넘어갔는지 계산하면 됨.

- 개략적인 아키텍쳐

  - 우리 프로젝트 상황에서는 : 개별 3rd party에서 그들이 apigateway에서 ratelimiter를 구현해두는 것이 바람직해보이나, 일단 우리가 설정할순 없으니 우리쪽에서 한다고 하면 API 엔드 포인트나 서비스단위로 할 필요는 있어보인다.

- 멀티인스턴스 환경에서 비율을 제한할 2가지 방법

  - 링크 : https://engineering.linecorp.com/ko/blog/high-throughput-distributed-rate-limiter
  - ![분산현 인메모리 비율 제한기](https://engineering.linecorp.com/wp-content/uploads/2020/05/pasted-image-0-2-1024x835.png)
    | **중앙 저장소** | **분산 인메모리** |
    | --- | --- |
    | ✅ 요청을 분산할 필요가 없다. | ✅ 높은 처리량을 제공할 수 있다. |
    | ✅ 비율 한도를 최대한 사용할 수 있다. | ✅ 지연 시간이 증가하지 않는다. |
    | ❌ DB 요청 때문에 지연 시간이 증가한다. | ❌ 트래픽이 균등하게 분산되지 않는다면 비율 한도를 최대한 활용하지 못한다. |
    | ❌ 확장하기 어렵다. | ❌ 시스템 시계 동기화가 필요하다. |
    | ❌ 단일 장애 지점이 발생한다. | ❌ 소비자 인스턴스 수를 관리하기 위해 추가 설정 시스템이 필요하다. |

- resilence4j 의 ratelimiter는 fixed window 기반의 알고리즘을 사용하는것으로 보임(추정)
  - https://resilience4j.readme.io/docs/ratelimiter#internals
  - 특정 시기에 부하가 몰릴경우 2배의 부하가 갈수도 있구나 (추정. 책의 내용 토대로)
